{"uid":"fc5349aa6dac0f8","name":"test_all_high_risk_scenarios[Ctier_AboveMaxVehicleAgeAtEnd]","fullName":"tests.test_high_risk#test_all_high_risk_scenarios","historyId":"2ad08968d5cdaf4573579fe8c8153d91","time":{"start":1761736181271,"stop":1761736202021,"duration":20750},"status":"failed","statusMessage":"AssertionError: One or more DeepEval metrics failed. Check attached report details.\nassert True is False","statusTrace":"azure_model = <src.test_azure.AzureOpenAIModel object at 0x000001FC3A10F4D0>\nscenario_data = {'input_file': 'high_risk/case_04/input.json', 'output_file': 'high_risk/case_04/output.json', 'scenario_name': 'Ctier_AboveMaxVehicleAgeAtEnd'}\n\n    @pytest.mark.parametrize(\n        \"scenario_data\",\n        # CRITICAL: Call the fixture function (low_risk_scenarios()) to get the list of data\n        HIGH_RISK_DATA,\n        # Use the scenario_name for clear output in the test report\n        ids=[s[\"scenario_name\"] for s in HIGH_RISK_DATA]\n    )\n    def test_all_high_risk_scenarios(azure_model, scenario_data):\n    \n        scenario_name = scenario_data['scenario_name']\n    \n    \n        # 1. Define the GEval metric, passing the necessary model fixture\n        ###rename to \"process adherence metric\"\n        overall_model_evaluation_metric = GEval(\n            name=\"Analysis Evaluation\",\n            evaluation_steps=[\n            \"1. Ignore and do not penalise any mention of the absence or unavailability of a credit report or any uses of it in the reasonings or any flags as a critical issue as this is an expected mistake of the model. Any further consequences of this missing credit report that are highlighted should also not be penalised.\",\n            \"2. Check if the 'actual output' follows the steps detailed in 'retrieval context\",\n            \"3. Assess if the 'actual output' covers ALL points in the 'retrieval context'.\",\n            \"4. Mention where 'actual output' has failed to follow the 'retrieval context\",\n            \"5. Mention and penalise where false mismatches have been highligted in the 'actual output'\",\n            \"6. Once again, IGNORE and DO NOT penalise any mention of the absence or unavailability of a credit report or any uses of it in the reasonings\",\n            \"7. IGNORE AND DO NOT PENALISE any flags of a missing credit report as a critical issue as this is an expected mistake of the model. Any further consequences of this missing credit report that are highlighted should also not be penalised.\",\n            \"8. Assign a final score from 0.0 to 1.0 based on the combined assessment.\",\n            \"9. Present findings in basic, easy to understand English\"\n    \n    \n        ],\n            evaluation_params=[LLMTestCaseParams.ACTUAL_OUTPUT, LLMTestCaseParams.INPUT, LLMTestCaseParams.RETRIEVAL_CONTEXT],\n            model=azure_model,\n            threshold=0.5\n        )\n    \n        output_hallucination = GEval(\n            name=\"Output Hallucination\",\n            evaluation_steps=[\n            \"1. Ignore and do not penalise any mention of the absence or unavailability of a credit report or any uses of it in the reasonings or any flags as a critical issue as this is an expected mistake of the model. Any further consequences of this missing credit report that are highlighted should also not be penalised.\",\n            \"2. Read the 'actual output' and compare the findings to what is in the 'input'\",\n            \"3. Assess if the 'actual output' is faithful. Mention any hallucinations or if anything has been made up except for the missing credit report\",\n            \"4. Do not judge the 'actual_output' based on how well it follows the steps in the 'retrieval context'. The only thing you should judge is if any hallucinations are present except for the missing credit report\",\n            \"5. Once again, IGNORE and DO NOT penalise any mention of the absence or unavailability of a credit report or any uses of it in the reasonings\",\n            \"6. IGNORE AND DO NOT PENALISE any flags of a missing credit report as a critical issue as this is an expected mistake of the model. Any further consequences of this missing credit report that are highlighted should also not be penalised.\",\n            \"7. Assign a final score from 0.0 to 1.0 based on the combined assessment of steps 1, 2, 3, and 4. **ENSURE the penalty for the continued mention and analysis based on a missing credit report (Step 1, 5 and 6) is 0.0.**\",\n            \"8. Present findings in basic, easy to understand English\"\n    \n    \n    \n        ],\n            evaluation_params=[LLMTestCaseParams.ACTUAL_OUTPUT, LLMTestCaseParams.INPUT, LLMTestCaseParams.RETRIEVAL_CONTEXT],\n            model=azure_model,\n            threshold=0.5\n        )\n    \n    \n        test_case = create_deepeval_test_case(scenario_data)\n    \n        metrics_to_run = [\n            overall_model_evaluation_metric,\n            output_hallucination\n        ]\n    \n    \n        #ALLURE REPORTING\n         # --- 2. RUN METRICS INDIVIDUALLY AND COLLECT RESULTS ---\n        # We will use a dictionary to store results and track failure states\n        results = {}\n        test_failed = False\n    \n        # Use a try/except structure for each metric to prevent the entire test from exiting\n        # prematurely before other metric scores are calculated/logged.\n        for metric in metrics_to_run:\n            try:\n                # Calculate the score and reason *without* using assert_test yet\n                metric.measure(test_case)\n    \n                results[metric.name] = {\n                    \"score\": metric.score,\n                    \"reason\": metric.reason,\n                    \"status\": \"PASS\" if metric.is_successful() else \"FAIL\"\n                }\n                if not metric.is_successful():\n                    test_failed = True\n    \n            except Exception as e:\n                # Handle unexpected errors during metric evaluation (e.g., LLM server error)\n                results[metric.name] = {\n                    \"score\": 0.0,\n                    \"reason\": f\"Evaluation Error: {e}\",\n                    \"status\": \"ERROR\"\n                }\n                test_failed = True\n    \n        # --- 3. LOG ALL RESULTS TO ALLURE ---\n        #log input\n        allure.attach(\n            test_case.input,\n            name=f\"Input Data: {scenario_data['scenario_name']}\", # <-- Unique name defined once\n            attachment_type=allure.attachment_type.JSON\n        )\n        #log output\n        with allure.step(f\"Evaluate Scenario: {scenario_data['scenario_name']}\"):\n            allure.attach(test_case.actual_output, name=\"AI Raw JSON Output\", attachment_type=allure.attachment_type.JSON)\n    \n            for name, data in results.items():\n                allure.attach(\n                    f\"Score: {data['score']:.4f}\\nStatus: {data['status']}\\nReasoning: {data['reason']}\",\n                    name=f\"{name} ({data['status']})\",\n                    attachment_type=allure.attachment_type.TEXT\n                )\n    \n        # --- 4. FINAL ASSERTION ---\n        # This single, final assertion controls the overall test status in Pytest/Allure.\n>       assert test_failed is False, \"One or more DeepEval metrics failed. Check attached report details.\"\nE       AssertionError: One or more DeepEval metrics failed. Check attached report details.\nE       assert True is False\n\ntests\\test_high_risk.py:132: AssertionError","flaky":false,"newFailed":false,"newBroken":false,"newPassed":false,"retriesCount":0,"retriesStatusChange":false,"beforeStages":[{"name":"event_loop_policy","time":{"start":1761736048549,"stop":1761736048549,"duration":0},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"hasContent":false,"attachmentStep":false,"attachmentsCount":0,"shouldDisplayMessage":false},{"name":"azure_model","time":{"start":1761736048550,"stop":1761736048979,"duration":429},"status":"passed","steps":[],"attachments":[],"parameters":[],"stepsCount":0,"hasContent":false,"attachmentStep":false,"attachmentsCount":0,"shouldDisplayMessage":false}],"testStage":{"status":"failed","statusMessage":"AssertionError: One or more DeepEval metrics failed. Check attached report details.\nassert True is False","statusTrace":"azure_model = <src.test_azure.AzureOpenAIModel object at 0x000001FC3A10F4D0>\nscenario_data = {'input_file': 'high_risk/case_04/input.json', 'output_file': 'high_risk/case_04/output.json', 'scenario_name': 'Ctier_AboveMaxVehicleAgeAtEnd'}\n\n    @pytest.mark.parametrize(\n        \"scenario_data\",\n        # CRITICAL: Call the fixture function (low_risk_scenarios()) to get the list of data\n        HIGH_RISK_DATA,\n        # Use the scenario_name for clear output in the test report\n        ids=[s[\"scenario_name\"] for s in HIGH_RISK_DATA]\n    )\n    def test_all_high_risk_scenarios(azure_model, scenario_data):\n    \n        scenario_name = scenario_data['scenario_name']\n    \n    \n        # 1. Define the GEval metric, passing the necessary model fixture\n        ###rename to \"process adherence metric\"\n        overall_model_evaluation_metric = GEval(\n            name=\"Analysis Evaluation\",\n            evaluation_steps=[\n            \"1. Ignore and do not penalise any mention of the absence or unavailability of a credit report or any uses of it in the reasonings or any flags as a critical issue as this is an expected mistake of the model. Any further consequences of this missing credit report that are highlighted should also not be penalised.\",\n            \"2. Check if the 'actual output' follows the steps detailed in 'retrieval context\",\n            \"3. Assess if the 'actual output' covers ALL points in the 'retrieval context'.\",\n            \"4. Mention where 'actual output' has failed to follow the 'retrieval context\",\n            \"5. Mention and penalise where false mismatches have been highligted in the 'actual output'\",\n            \"6. Once again, IGNORE and DO NOT penalise any mention of the absence or unavailability of a credit report or any uses of it in the reasonings\",\n            \"7. IGNORE AND DO NOT PENALISE any flags of a missing credit report as a critical issue as this is an expected mistake of the model. Any further consequences of this missing credit report that are highlighted should also not be penalised.\",\n            \"8. Assign a final score from 0.0 to 1.0 based on the combined assessment.\",\n            \"9. Present findings in basic, easy to understand English\"\n    \n    \n        ],\n            evaluation_params=[LLMTestCaseParams.ACTUAL_OUTPUT, LLMTestCaseParams.INPUT, LLMTestCaseParams.RETRIEVAL_CONTEXT],\n            model=azure_model,\n            threshold=0.5\n        )\n    \n        output_hallucination = GEval(\n            name=\"Output Hallucination\",\n            evaluation_steps=[\n            \"1. Ignore and do not penalise any mention of the absence or unavailability of a credit report or any uses of it in the reasonings or any flags as a critical issue as this is an expected mistake of the model. Any further consequences of this missing credit report that are highlighted should also not be penalised.\",\n            \"2. Read the 'actual output' and compare the findings to what is in the 'input'\",\n            \"3. Assess if the 'actual output' is faithful. Mention any hallucinations or if anything has been made up except for the missing credit report\",\n            \"4. Do not judge the 'actual_output' based on how well it follows the steps in the 'retrieval context'. The only thing you should judge is if any hallucinations are present except for the missing credit report\",\n            \"5. Once again, IGNORE and DO NOT penalise any mention of the absence or unavailability of a credit report or any uses of it in the reasonings\",\n            \"6. IGNORE AND DO NOT PENALISE any flags of a missing credit report as a critical issue as this is an expected mistake of the model. Any further consequences of this missing credit report that are highlighted should also not be penalised.\",\n            \"7. Assign a final score from 0.0 to 1.0 based on the combined assessment of steps 1, 2, 3, and 4. **ENSURE the penalty for the continued mention and analysis based on a missing credit report (Step 1, 5 and 6) is 0.0.**\",\n            \"8. Present findings in basic, easy to understand English\"\n    \n    \n    \n        ],\n            evaluation_params=[LLMTestCaseParams.ACTUAL_OUTPUT, LLMTestCaseParams.INPUT, LLMTestCaseParams.RETRIEVAL_CONTEXT],\n            model=azure_model,\n            threshold=0.5\n        )\n    \n    \n        test_case = create_deepeval_test_case(scenario_data)\n    \n        metrics_to_run = [\n            overall_model_evaluation_metric,\n            output_hallucination\n        ]\n    \n    \n        #ALLURE REPORTING\n         # --- 2. RUN METRICS INDIVIDUALLY AND COLLECT RESULTS ---\n        # We will use a dictionary to store results and track failure states\n        results = {}\n        test_failed = False\n    \n        # Use a try/except structure for each metric to prevent the entire test from exiting\n        # prematurely before other metric scores are calculated/logged.\n        for metric in metrics_to_run:\n            try:\n                # Calculate the score and reason *without* using assert_test yet\n                metric.measure(test_case)\n    \n                results[metric.name] = {\n                    \"score\": metric.score,\n                    \"reason\": metric.reason,\n                    \"status\": \"PASS\" if metric.is_successful() else \"FAIL\"\n                }\n                if not metric.is_successful():\n                    test_failed = True\n    \n            except Exception as e:\n                # Handle unexpected errors during metric evaluation (e.g., LLM server error)\n                results[metric.name] = {\n                    \"score\": 0.0,\n                    \"reason\": f\"Evaluation Error: {e}\",\n                    \"status\": \"ERROR\"\n                }\n                test_failed = True\n    \n        # --- 3. LOG ALL RESULTS TO ALLURE ---\n        #log input\n        allure.attach(\n            test_case.input,\n            name=f\"Input Data: {scenario_data['scenario_name']}\", # <-- Unique name defined once\n            attachment_type=allure.attachment_type.JSON\n        )\n        #log output\n        with allure.step(f\"Evaluate Scenario: {scenario_data['scenario_name']}\"):\n            allure.attach(test_case.actual_output, name=\"AI Raw JSON Output\", attachment_type=allure.attachment_type.JSON)\n    \n            for name, data in results.items():\n                allure.attach(\n                    f\"Score: {data['score']:.4f}\\nStatus: {data['status']}\\nReasoning: {data['reason']}\",\n                    name=f\"{name} ({data['status']})\",\n                    attachment_type=allure.attachment_type.TEXT\n                )\n    \n        # --- 4. FINAL ASSERTION ---\n        # This single, final assertion controls the overall test status in Pytest/Allure.\n>       assert test_failed is False, \"One or more DeepEval metrics failed. Check attached report details.\"\nE       AssertionError: One or more DeepEval metrics failed. Check attached report details.\nE       assert True is False\n\ntests\\test_high_risk.py:132: AssertionError","steps":[{"name":"Evaluate Scenario: Ctier_AboveMaxVehicleAgeAtEnd","time":{"start":1761736202019,"stop":1761736202020,"duration":1},"status":"passed","steps":[],"attachments":[{"uid":"ce19397ae80f16bc","name":"AI Raw JSON Output","source":"ce19397ae80f16bc.json","type":"application/json","size":5695},{"uid":"3f1548440a208f1d","name":"Analysis Evaluation (PASS)","source":"3f1548440a208f1d.txt","type":"text/plain","size":912},{"uid":"49b5b2effe6ceaa3","name":"Output Hallucination (FAIL)","source":"49b5b2effe6ceaa3.txt","type":"text/plain","size":642}],"parameters":[],"stepsCount":0,"hasContent":true,"attachmentStep":false,"attachmentsCount":3,"shouldDisplayMessage":false}],"attachments":[{"uid":"8cb6a89cc5d1bad3","name":"Input Data: Ctier_AboveMaxVehicleAgeAtEnd","source":"8cb6a89cc5d1bad3.json","type":"application/json","size":6091}],"parameters":[],"stepsCount":1,"hasContent":true,"attachmentStep":false,"attachmentsCount":4,"shouldDisplayMessage":true},"afterStages":[],"labels":[{"name":"parentSuite","value":"tests"},{"name":"suite","value":"test_high_risk"},{"name":"host","value":"LAPTOP-GT42QV3"},{"name":"thread","value":"43640-MainThread"},{"name":"framework","value":"pytest"},{"name":"language","value":"cpython3"},{"name":"package","value":"tests.test_high_risk"},{"name":"resultFormat","value":"allure2"}],"parameters":[{"name":"scenario_data","value":"{'scenario_name': 'Ctier_AboveMaxVehicleAgeAtEnd', 'input_file': 'high_risk/case_04/input.json', 'output_file': 'high_risk/case_04/output.json'}"}],"links":[],"hidden":false,"retry":false,"extra":{"severity":"normal","retries":[],"categories":[{"name":"Product defects","matchedStatuses":[]}],"tags":[]},"source":"fc5349aa6dac0f8.json","parameterValues":["{'scenario_name': 'Ctier_AboveMaxVehicleAgeAtEnd', 'input_file': 'high_risk/case_04/input.json', 'output_file': 'high_risk/case_04/output.json'}"]}